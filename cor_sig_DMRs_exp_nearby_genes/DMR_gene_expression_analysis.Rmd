---
title: "Correlation of AD associated methylation changes with expressions of nearby genes"
date: "`r format(Sys.time(), '%d %B %Y')`"
author:
- Tiago C. Silva, Lanyu Zhang, Lily Wang
output:
  rmarkdown::html_document:
    theme: lumen
    toc: true
    number_sections: true
    df_print: paged
    code_download: true
    code_folding: show
    toc_float: false
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      fig.width = 10, 
                      fig.height = 13)
knitr::opts_knit$set(progress = FALSE, verbose = FALSE,root.dir = "..")
show.section.code <- FALSE
```


`r if(show.section.code){"# Load libraries"}`


```{r, include = show.section.code}
suppressMessages({
  library(ComplexHeatmap)
  library(SummarizedExperiment)
  library(GenomicRanges)
  devtools::load_all("~/Documents/packages/coMethDMR//")
  library(TCGAbiolinks)
  library(ggpubr)
  library(dplyr)
  library(tidyr)
  library(ggpubr)
  library(DelayedMatrixStats)
  devtools::load_all("~/Documents/packages/coMethDMR/")
  devtools::load_all("~/Dropbox (BBSR)/PanCancer/methTF/")
  library(doParallel)
  registerDoParallel(4)
  gene.info <- TCGAbiolinks::get.GRCh.bioMart("hg19")
})
```


# Datasets

- DNAm data – in file 'ROSMAP_QNBMIQ_PCfiltered.RDS' 
- RNAseq data – in files:
- 'ROSMAP_RNAseq_FPKM_gene_plates_1_to_6_normalized.tsv'
- 'ROSMAP_RNAseq_FPKM_gene_plates_7_to_8_normalized.tsv'  
- Link for IDs – in file "ROSMAP_IDkey"
- column "mwas_id" is for DNAm data 
- column "rnaseq_id" is for rnaseq
- Phenotype data:  pheno_withNeuronProp_df.RDS

## Code to get matched data
```{R, code = readLines("data.R"),eval = FALSE}
```


```{R, fig.height = 6, include = FALSE, eval = FALSE}

## Reading data created previously
data.path <- "../code_validation/Meta_analysis_code/DATASETS/ROSMAP"
load("data/matched_data.rda")
dim(matched.dnam)
dim(matched.exp)
matched.exp <- matched.exp[rowSums(matched.exp) > 0,]
matched.phenotype
gghistogram(matched.phenotype$braaksc,
            bins = 7,
            fill = "black",
            color = "white",
            alpha = 1)
```


# Region analysis
## Get metadata results

```{R}
meta.analysis.folder <- "../code_validation/Meta_analysis_code/meta_analysis_region_results/"
# focus on significant methylation regions with FDR < 0.05 in file “meta_analysis_ALL_df.csv”
analysis <- readr::read_csv(
  file.path(meta.analysis.folder,"step1_meta_analysis/meta_analysis_ALL_df.csv"),
  col_types = readr::cols()
)

region.analysis <- readr::read_csv(
  file.path(meta.analysis.folder,"step4_dmr_vs_cpgs/meta_analysis_sig_no_crossHyb_smoking_ov_comb_p_with_sig_single_cpgs.csv"),
  col_types = readr::cols()
)

dmr <- region.analysis %>% filter(!is.na(ROSMAP_coMethRegion))
dim(dmr)
dmr.hypo <- region.analysis %>% filter(estimate < 0)
dim(dmr.hypo)
dmr.hyper <- region.analysis %>% filter(estimate > 0)
dim(dmr.hyper)
```

## Analysis: RNA vs DNAm

For each significant co-methylated region, we looked for genes within $250Kbp$, removed confounding effects in gene expression and DNA methylation levels, and then correlated DNAm with gene expression with the 
following model, for cases and controls separately:

$$rna_{residual} \sim met_{residual} $$

### Remove confounding effects in DNAm data

$Median(\text{DNAm m-values in DMR})  \sim celltype.proportion + batch + \text{sample plate}  + ageAtDeath + sex => \text{DNAm residuals}$

```{R, eval = FALSE}
file <- "results/ROSMAP.probes.all.meta.analysis.regions.rda"
if(!file.exists(file)){
  regions.name  <- na.omit(results.meta.analysis.region$ROSMAP_coMethRegion) %>% as.character() %>% unique()
  probes.all.regions <- GetCpGsInAllRegion(regions.name, progress = TRUE, nCores_int = 10)
  save(probes.all.regions, file = file)
} else {
  load(file)
}


median.met <- plyr::ldply(
  probes.all.regions[unique(dmr$ROSMAP_coMethRegion)],
  function(probes){
    aux <- colMedians(matched.dnam,rows = rownames(matched.dnam) %in% probes)
    aux
  },
  .progress = "time",
  .parallel = TRUE,
  .inform = TRUE,
  .id = "region" 
)

rownames(median.met) <- median.met$region %>% as.character()
median.met$region <- NULL
colnames(median.met) <- colnames(matched.dnam)

# 1) remove confounding effects in DNAm data: 
resid_met <- GetResiduals(
  dnam = median.met,
  betaToM = TRUE, #converts to Mvalues for fitting linear model 
  pheno_df = matched.phenotype,
  covariates_char = c("Sample_Plate", "prop.neuron", "batch","msex","age_death"), 
  nCores_int = 1,
  progressbar = TRUE  
)
```

### Remove confounding effects in gene expression data


$log2(RNA) \sim ageAtDeath + sex  + \text{markers for cell types}  => \text{RNA residuals}$
```{R residual, eval = FALSE}
matched.exp.log2 <- log2(matched.exp + 1)
markers <-
  t(matched.exp.log2[c(
    "ENSG00000111674",
    "ENSG00000129226",
    "ENSG00000131095",
    "ENSG00000205927",
    "ENSG00000174059"
  ), ])
colnames(markers) <- c("markers_ENO2",
                       "markers_OLIG2",
                       "markers_CD34",
                       "markers_CD68",
                       "markers_GFAP")
matched.phenotype$rnaseq_id  <- map$rnaseq_id[match(matched.phenotype$Sample,map$mwas_id)]
resid_exp <- plyr::adply(.data = matched.exp.log2,
                         .margins = 1, 
                         function(row){
                           val <- t(row)
                           colnames(val) <- "val"
                           dat <- cbind(val, 
                                        matched.phenotype,
                                        markers
                           )
                           dat$val <- as.numeric(dat$val)
                           fitE <- lm("val ~ age_death + msex + markers_ENO2 + markers_OLIG2 + markers_CD34 + markers_CD68 + markers_GFAP", 
                                      data = dat, 
                                      na.action = na.exclude)
                           residuals(fitE)
                         }, .progress = "time",
                         .parallel = TRUE)
rownames(resid_exp) <- rownames(matched.exp.log2)
```

```{R,eval = FALSE}
save(resid_exp,
     resid_met,
     file = "data/residuals.rda")
```

```{R,eval = TRUE, include = FALSE}
load("data/residuals.rda")
```


## Map region to genes +-250kb

The function `getDNAm.target` will extend the regions $+-250Kbp$ and return the overlapping genes.


```{R}
regions.gr <- rownames(resid_met) %>% 
  as.data.frame %>% 
  tidyr::separate(col = ".",into = c("chr","start","end"))  %>%
  makeGRangesFromDataFrame()
names(regions.gr) <- rownames(resid_met)
regions.gr

# function available in methTF package https://gitlab.com/tiagochst/methtf
regions.genes <- get_region_target_gene(regions.gr = regions.gr,
                                        genome = "hg19",
                                        method = "window",
                                        window.width = 500 * 10 ^ 3) # 500 kb
regions.genes <- regions.genes %>%
  dplyr::filter(regions.genes$gene_ensembl_gene_id %in% rownames(resid_exp))

dim(regions.genes)
head(regions.genes)
```


## Target vs DNAm residual

Linear models:

- For cases (Braak stage 3-6): $\text{RNA residuals} \sim \text{DNAm residuals}$
- For controls (Braak stage 0-2): $\text{RNA residuals} \sim \text{DNAm residuals}$

```{R, eval = FALSE}
# http://www.r-tutor.com/elementary-statistics/simple-linear-regression/residual-plot
tab <- plyr::adply(
  regions.genes,
  .margins = 1,
  .fun = function(row) {
    tryCatch({
      rna.target <-
        resid_exp[rownames(resid_exp) == row$gene_ensembl_gene_id, , drop = FALSE]
      met.residual <- resid_met[rownames(resid_met) == as.character(row$regionID), ]
      
      df <- data.frame(
        rna.residual = rna.target %>% as.numeric,
        met.residual = met.residual %>% as.numeric,
        Braak_stage = matched.phenotype$braaksc,
        group = ifelse(matched.phenotype$braaksc < 3, "Control", "Case")
      )
      
      # 2) fit linear model to cases and controls seperately:
      # For cases (Braak stage 3-6)
      # RNA_residuals ~ DNAm_residuals
      results.cases <-  lm (
        rna.residual ~ met.residual,
        data = df[df$Braak_stage > 2, ]
      )
      results.cases.pval <- summary(results.cases)$coefficients[-1, 4, drop = F] %>% t %>% as.data.frame()
      results.cases.estimate <- summary(results.cases)$coefficients[-1, 1, drop = F] %>% t %>% as.data.frame()
      colnames(results.cases.pval) <- paste0("cases_pval_", colnames(results.cases.pval))
      colnames(results.cases.estimate) <- paste0("cases_estimate_", colnames(results.cases.estimate))
      
      # For controls (Braak stage 0 -2)
      # RNA_residuals ~ DNAm_residuals
      results.control <- lm (
        rna.residual ~ met.residual,
        data = df[df$Braak_stage < 3, ]
      )
      results.control.pval <- summary(results.control)$coefficients[-1, 4, drop = F] %>% t %>% as.data.frame()
      results.control.estimate <- summary(results.control)$coefficients[-1, 1, drop = F] %>% t %>% as.data.frame()
      colnames(results.control.pval) <- paste0("control_pval_", colnames(results.control.pval))
      colnames(results.control.estimate) <- paste0("control_estimate_", colnames(results.control.estimate))
      
      return(
        data.frame(
          cbind(
            results.cases.pval,
            results.cases.estimate,
            results.control.pval,
            results.control.estimate
          ),
          row.names = NULL,
          stringsAsFactors = FALSE
        ))
    }, error = function(e) {
      print(row)
      return()
    })
  },
  .id = NULL,
  .progress = "time",
  .parallel = TRUE,
  .inform = TRUE
)
readr::write_csv(tab,path = "results/results_regions_lm_250kb_window.csv")
```



```{R, include = FALSE}
### Plots
plotTargetDNAm <- function(row){
  rna.target <- resid_exp[rownames(resid_exp) == row$gene_ensembl_gene_id, , drop = FALSE]
  met.residual <- resid_met[rownames(resid_met) == as.character(row$regionID), ]
  
  df <- data.frame(
    rna.residual = rna.target %>% as.numeric,
    met.residual = met.residual %>% as.numeric,
    Braak_stage = matched.phenotype$braaksc,
    Braak_group = ifelse(matched.phenotype$braaksc < 3, "Control", "Case")
  )
  
  target.lab <- bquote(atop("Target" ~.(row$gene_external_gene_name), "Residuals"))
  region.lab <- "DNA methylation residual-values"
  
  dnam.target.plot <- ggscatter(
    df, 
    x = "met.residual", 
    y = "rna.residual",
    size = 1,
    color = "Braak_group",
    fill = "Braak_group",
    add = "reg.line",  # Add regressin line
    # add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
    conf.int = TRUE, # Add confidence interval
    #cor.coef = TRUE # Add correlation coefficient. see ?stat_cor
    # cor.coeff.args = list(method = "pearson", label.x = 0, label.sep = "\n")
  ) + ylab(target.lab) + xlab(region.lab) + 
    labs(fill = "Braak group", color = "Braak group") +
    stat_cor(aes(color = Braak_group))  
  # + geom_smooth(method = MASS::rlm, se = FALSE) 
  
  # quintile plots DNAm
  quant <-  quantile(df$DNAm,na.rm = TRUE)
  quantile_lower_cutoff <- quant[2]
  quantile_upper_cutoff <- quant[4]
  range1 <- paste0("[",paste(round(quant[1:2],digits = 3),collapse = ","),"]")
  range2 <- paste0("[",paste(round(quant[4:5],digits = 3),collapse = ","),"]")
  
  df$group <- NA
  df$group[df$DNAm > quantile_upper_cutoff] <- paste0("DNAm high quartile ", range2) 
  df$group[df$DNAm < quantile_lower_cutoff] <- paste0("DNAm low quartile " , range1) 
  
  # quintile plots TF
  quant <-  quantile(df$TF,na.rm = TRUE)
  quantile_lower_cutoff <- quant[2]
  quantile_upper_cutoff <- quant[4]
  range1 <- paste0("[",paste(round(quant[1:2],digits = 3),collapse = ","),"]")
  range2 <- paste0("[",paste(round(quant[4:5],digits = 3),collapse = ","),"]")
  
  for(idx in grep("pval|fdr|value",colnames(row))) row[,idx] <- format.pval(row[,idx]  %>% pull(),digits = 3)
  for(idx in grep("estimate|median|minus",colnames(row))) row[,idx] <- format(row[,idx]  %>% pull(),digits = 3)
  
  #colnames(row)[15] <- "Tumor_median - Normal_median"
  base_size <- 9
  aux <- row[,c("regionID",
                "gene_external_gene_name",
                "Distance.region.gene")]
  colnames(aux) <- c("regionID","Gene","Dist. region/gene (bp)")
  table.plot1 <- ggtexttable(aux %>% 
                               t() %>% 
                               as_tibble(rownames = "Variable"), 
                             rows = NULL, 
                             cols = NULL,
                             theme = ttheme("mOrange", base_size = base_size)
  )
  
  
  table.plot2a <- row[,grep("cases_estimate",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  colnames(table.plot2a)[2] <- "Estimate"
  table.plot2a$Variable <- gsub("cases_estimate_","",table.plot2a$Variable)
  table.plot2b <- row[,grep("cases_pval",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  table.plot2b$Variable <- gsub("cases_pval_","",table.plot2b$Variable)
  colnames(table.plot2b)[2] <- "P-value"
  table.plot2 <- merge(table.plot2a,table.plot2b, by = "Variable",sort = FALSE)
  
  table.plot2 <- ggtexttable(table.plot2,
                             rows = NULL, 
                             cols = c("DNAm vs Target\n Cases","Estimate","P-Values"),
                             theme = ttheme("mOrange", base_size = base_size)
  )
  
  table.plot3a <- row[,grep("control_estimate",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  
  colnames(table.plot3a)[2] <- "Estimate"
  table.plot3a$Variable <- gsub("control_estimate_","",table.plot3a$Variable)
  
  table.plot3b <- row[,grep("control_pval",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  
  table.plot3b$Variable <- gsub("control_pval_","",table.plot3b$Variable)
  colnames(table.plot3b)[2] <- "P-value"
  table.plot3 <- merge(table.plot3a,table.plot3b, by = "Variable",sort = FALSE)
  
  table.plot3 <- ggtexttable(table.plot3,
                             rows = NULL, 
                             cols = c("DNAm vs Target\n Control","Estimate","P-Values"),
                             theme = ttheme("mOrange", base_size = base_size)
  )
  
  
  # Arrange the plots on the same page
  plot.table <- ggarrange(
    ggarrange(table.plot1,
              table.plot2,
              ncol = 2),
    ggarrange(
      table.plot3,
      ncol = 1),
    ggarrange(dnam.target.plot,
              ncol = 1),
    nrow = 3,
    heights = c(0.4,0.6,2))
  plot.table
}
```



```{R  model_all_plot_neg_cpg, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}
#### Lowest interaction p-values

tab <- readr::read_csv("results/results_regions_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(tab[order(tab$all_pval_met.residual.groupControl)[1:10],],
                    .margins = 1,
                    .fun = function(row){
                      plotTargetDNAm(row)
                    },.inform = TRUE
)
list
```



```{R, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}
#### Lowest DNAm p-values

tab <- readr::read_csv("results/results_regions_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(tab[order(tab$all_pval_met.residual)[1:10],],
                    .margins = 1,
                    .fun = function(row){
                      plotTargetDNAm(row)
                    },.inform = TRUE
)
list
```



```{R, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}

#### Lowest cases DNAm p-values

tab <- readr::read_csv("results/results_regions_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(tab[order(tab$cases_pval_met.residual)[1:10],],
                    .margins = 1,
                    .fun = function(row){
                      plotTargetDNAm(row)
                    },.inform = TRUE
)
list
```



```{R, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}

#### Lowest control DNAm p-values
tab <- readr::read_csv("results/results_regions_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(
  tab[order(tab$control_pval_met.residual)[1:10],],
  .margins = 1,
  .fun = function(row){
    plotTargetDNAm(row)
  },.inform = TRUE
)
list
```


### Results

```{R}
tab <- readr::read_csv("results/results_regions_lm_250kb_window.csv", col_types = readr::cols())
tab$fdr.controls <- p.adjust(tab$control_pval_met.residual,method = "fdr")
tab$fdr.cases <- p.adjust(tab$cases_pval_met.residual,method = "fdr")

output <- tab[,c("regionID","gene_external_gene_name",
                 "cases_estimate_met.residual","cases_pval_met.residual","fdr.cases",
                 "control_estimate_met.residual","control_pval_met.residual","fdr.controls")] 
colnames(output) <- c("coMethDMR",
                      "geneSymbol",
                      "estimate.cases",
                      "pval.cases",
                      "estimate.controls",
                      "pval.controls"
                      )


cols <- c(grep("ROSMAP_coMethRegion",colnames(region.analysis)),
          grep("Relation",colnames(region.analysis)):grep("^smoke_bi$",colnames(region.analysis)))
output2 <- merge(output,
                 region.analysis[,cols],
                 by.x = "coMethDMR", 
                 by.y = "ROSMAP_coMethRegion",
                 all.x = TRUE)
```

```{R, eval = FALSE}
write.csv(output2,file = "results/results_regions_lm_250kb_window_renamed.csv")
```

```{R, eval = FALSE, include = FALSE}
output %>% dplyr::filter(output$fdr.cases < 0.01 | output$fdr.controls < 0.01) %>%
  DT::datatable(filter = 'top',
                style = "bootstrap",
                extensions = 'Buttons',
                options = list(scrollX = TRUE, 
                               dom = 'Bfrtip',
                               buttons = I('colvis'),
                               keys = TRUE, 
                               pageLength = 10), 
                rownames = FALSE,
                caption = "Liner model Target/DNAm results")
```


# Single cpg analysis
## Get metadata results

```{R}
single.cpg.analysis <- readr::read_csv(
  "../code_validation/Meta_analysis_code/meta_analysis_single_cpg_results/meta_analysis_single_cpg_sig_no_crossHyb_smoking_df.csv", 
  col_types = readr::cols()
)

dmc <- single.cpg.analysis %>% filter(!is.na(ROSMAP_pValue))
dim(dmc)
dmc.hypo <- dmc %>% filter(estimate < 0)
dim(dmc.hypo)
dmc.hyper <- dmc %>% filter(estimate > 0)
dim(dmc.hyper)
```


## Analysis: RNA vs DNAm

For each CpG significantly associated with Braak stage, we looked for genes within $250Kbp$, removed confounding effects in gene expression and DNA methylation levels, and then correlated residual methylation with gene expression levels with the following model, for cases and controls separately:

$$rna_{residual} \sim met_{residual} $$

### Remove confounding effects in DNAm data

$Median(\text{DNAm m-values in DMR})  \sim celltype.proportion + batch + \text{sample plate}  + ageAtDeath + sex => \text{DNAm residuals}$

```{R, eval = FALSE}

# 1) remove confounding effects in DNAm data: 
resid_met_cpg <- GetResiduals(
  dnam = matched.dnam[dmc$cpg,],
  betaToM = TRUE, #converts to Mvalues for fitting linear model 
  pheno_df = matched.phenotype,
  covariates_char = c("Sample_Plate", "prop.neuron", "batch","msex","age_death"), 
  nCores_int = 1,
  progressbar = TRUE  
)
```


```{R,eval = FALSE}
save(resid_exp,
     resid_met_cpg,
     file = "data/residuals_cpg.rda")
```

```{R,eval = TRUE, include = FALSE}
load("data/residuals_cpg.rda")
```


## Map region to genes +-250kb

The function `get_region_target_gene` will extend the regions $+-250Kbp$ and return the overlapping genes.


```{R}
dmc.gr <- sesameData::sesameDataGet("HM450.hg19.manifest")[dmc$cpg,] 
regions.genes <- get_region_target_gene(
  regions.gr = dmc.gr,
  genome = "hg19",
  method = "window",
  window.width = 500 * 10 ^ 3) # 500 kb

regions.genes <- regions.genes %>%
  dplyr::filter(regions.genes$gene_ensembl_gene_id %in% rownames(resid_exp))
regions.genes$cpg <- names(dmc.gr)[
  match(
    regions.genes$regionID,paste0(as.data.frame(dmc.gr)$seqnames,
                                  ":",
                                  as.data.frame(dmc.gr)$start,"-",as.data.frame(dmc.gr)$end)
  )
  ]

dim(regions.genes)
head(regions.genes)
```


## Target vs DNAm residual

Linear models:
- For cases (Braak stage 3-6): $\text{RNA residuals} \sim \text{DNAm residuals}$
- For controls (Braak stage 0-2): $\text{RNA residuals} \sim \text{DNAm residuals}$

```{R, eval = FALSE}
# http://www.r-tutor.com/elementary-statistics/simple-linear-regression/residual-plot
tab.cpg <- plyr::adply(
  regions.genes,
  .margins = 1,
  .fun = function(row) {
    tryCatch({
      rna.target <-
        resid_exp[rownames(resid_exp) == row$gene_ensembl_gene_id, , drop = FALSE]
      met.residual <-
        resid_met_cpg[rownames(resid_met_cpg) == as.character(row$cpg), ]
      
      df <-
        data.frame(
          rna.residual = rna.target %>% as.numeric,
          met.residual = met.residual %>% as.numeric,
          Braak_stage = matched.phenotype$braaksc,
          group = ifelse(matched.phenotype$braaksc < 3, "Control", "Case")
        )
      
      # 2) fit linear model to cases and controls seperately:
      # For cases (Braak stage 3-6)
      #  RNA_residuals ~ DNAm_residuals
      results.cases <-
        lm (
          rna.residual ~ met.residual,
          data = df[df$Braak_stage > 2, ]
        )
      results.cases.pval <-
        summary(results.cases)$coefficients[-1, 4, drop = F] %>% t %>% as.data.frame()
      results.cases.estimate <-
        summary(results.cases)$coefficients[-1, 1, drop = F] %>% t %>% as.data.frame()
      colnames(results.cases.pval) <-
        paste0("cases_pval_", colnames(results.cases.pval))
      colnames(results.cases.estimate) <-
        paste0("cases_estimate_", colnames(results.cases.estimate))
      
      # For controls (Braak stage 0 -2)
      #  RNA_residuals ~ DNAm_residuals
      results.control <-
        lm (
          rna.residual ~ met.residual,
          data = df[df$Braak_stage < 3, ]
        )
      results.control.pval <-
        summary(results.control)$coefficients[-1, 4, drop = F] %>% t %>% as.data.frame()
      results.control.estimate <-
        summary(results.control)$coefficients[-1, 1, drop = F] %>% t %>% as.data.frame()
      colnames(results.control.pval) <-
        paste0("control_pval_", colnames(results.control.pval))
      colnames(results.control.estimate) <-
        paste0("control_estimate_", colnames(results.control.estimate))
      
      
      return(
        data.frame(
          cbind(
            results.cases.pval,
            results.cases.estimate,
            results.control.pval,
            results.control.estimate
          ),
          row.names = NULL,
          stringsAsFactors = FALSE
        ))
    }, error = function(e) {
      print(row)
      return()
    })
  },
  .id = NULL,
  .progress = "time",
  .parallel = TRUE,
  .inform = TRUE
)
readr::write_csv(tab.cpg,path = "results/results_single_cpg_lm_250kb_window.csv")
```



```{R, include = FALSE}
### Plots
plotTargetDNAm <- function(row){
  rna.target <-
    resid_exp[rownames(resid_exp) == row$gene_ensembl_gene_id, , drop = FALSE]
  met.residual <-
    resid_met_cpg[rownames(resid_met_cpg) == as.character(row$cpg), ]
  
  df <-
    data.frame(
      rna.residual = rna.target %>% as.numeric,
      met.residual = met.residual %>% as.numeric,
      Braak_stage = matched.phenotype$braaksc,
      Braak_group = ifelse(matched.phenotype$braaksc < 3, "Control", "Case")
    )
  
  target.lab <- bquote(atop("Target" ~.(row$gene_external_gene_name), "Residuals"))
  region.lab <- "DNA methylation residual-values"
  
  dnam.target.plot <- ggscatter(df, 
                                x = "met.residual", 
                                y = "rna.residual",
                                size = 1,
                                color = "Braak_group",
                                fill = "Braak_group",
                                add = "reg.line",  # Add regressin line
                                # add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                                conf.int = TRUE, # Add confidence interval
                                #cor.coef = TRUE # Add correlation coefficient. see ?stat_cor
                                # cor.coeff.args = list(method = "pearson", label.x = 0, label.sep = "\n")
  ) + ylab(target.lab) + xlab(region.lab) + 
    labs(fill = "Braak group", color = "Braak group") +
    stat_cor(aes(color = Braak_group))  
  
  # quintile plots DNAm
  quant <-  quantile(df$DNAm,na.rm = TRUE)
  quantile_lower_cutoff <- quant[2]
  quantile_upper_cutoff <- quant[4]
  range1 <- paste0("[",paste(round(quant[1:2],digits = 3),collapse = ","),"]")
  range2 <- paste0("[",paste(round(quant[4:5],digits = 3),collapse = ","),"]")
  
  df$group <- NA
  df$group[df$DNAm > quantile_upper_cutoff] <- paste0("DNAm high quartile ", range2) 
  df$group[df$DNAm < quantile_lower_cutoff] <- paste0("DNAm low quartile " , range1) 
  
  # quintile plots TF
  quant <-  quantile(df$TF,na.rm = TRUE)
  quantile_lower_cutoff <- quant[2]
  quantile_upper_cutoff <- quant[4]
  range1 <- paste0("[",paste(round(quant[1:2],digits = 3),collapse = ","),"]")
  range2 <- paste0("[",paste(round(quant[4:5],digits = 3),collapse = ","),"]")
  
  for(idx in grep("pval|fdr|value",colnames(row))) row[,idx] <- format.pval(row[,idx]  %>% pull(),digits = 3)
  for(idx in grep("estimate|median|minus",colnames(row))) row[,idx] <- format(row[,idx]  %>% pull(),digits = 3)
  
  #colnames(row)[15] <- "Tumor_median - Normal_median"
  base_size <- 9
  table.plot1 <- ggtexttable(row[,c("regionID",
                                    "gene_external_gene_name",
                                    "Distance.region.gene")] %>% 
                               t() %>% 
                               as_tibble(rownames = "Variable"), 
                             rows = NULL, 
                             cols = NULL,
                             theme = ttheme("mOrange", base_size = base_size)
  )
  
  
  table.plot2a <- row[,grep("cases_estimate",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  colnames(table.plot2a)[2] <- "Estimate"
  table.plot2a$Variable <- gsub("cases_estimate_","",table.plot2a$Variable)
  table.plot2b <- row[,grep("cases_pval",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  table.plot2b$Variable <- gsub("cases_pval_","",table.plot2b$Variable)
  colnames(table.plot2b)[2] <- "P-value"
  table.plot2 <- merge(table.plot2a,table.plot2b, by = "Variable",sort = FALSE)
  
  table.plot2 <- ggtexttable(table.plot2,
                             rows = NULL, 
                             cols = c("DNAm vs Target\n Cases","Estimate","P-Values"),
                             theme = ttheme("mOrange", base_size = base_size)
  )
  
  table.plot3a <- row[,grep("control_estimate",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  colnames(table.plot3a)[2] <- "Estimate"
  table.plot3a$Variable <- gsub("control_estimate_","",table.plot3a$Variable)
  table.plot3b <- row[,grep("control_pval",colnames(row),value = T),drop  = FALSE] %>% 
    t() %>% 
    as_tibble(rownames = "Variable")
  table.plot3b$Variable <- gsub("control_pval_","",table.plot3b$Variable)
  colnames(table.plot3b)[2] <- "P-value"
  table.plot3 <- merge(table.plot3a,table.plot3b, by = "Variable",sort = FALSE)
  
  table.plot3 <- ggtexttable(table.plot3,
                             rows = NULL, 
                             cols = c("DNAm vs Target\n Control","Estimate","P-Values"),
                             theme = ttheme("mOrange", base_size = base_size)
  )
  
  
  
  # Arrange the plots on the same page
  plot.table <- ggarrange(
    ggarrange(table.plot1,
              table.plot2,
              ncol = 2),
    ggarrange(
      table.plot3,
      ncol = 1),
    ggarrange(dnam.target.plot,
              ncol = 1),
    nrow = 3,
    heights = c(0.4,0.6,2))
  plot.table
}
```



```{R  model_all_plot_neg_region, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}
#### Lowest interaction p-values
tab <- readr::read_csv("results/results_single_cpg_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(tab[order(tab$all_pval_met.residual.groupControl)[1:10],],
                    .margins = 1,
                    .fun = function(row){
                      plotTargetDNAm(row)
                    },.inform = TRUE
)
list
```




```{R, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}
#### Lowest DNAm p-values
tab <- readr::read_csv("results/results_single_cpg_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(tab[order(tab$all_pval_met.residual)[1:10],],
                    .margins = 1,
                    .fun = function(row){
                      plotTargetDNAm(row)
                    },.inform = TRUE
)
list
```




```{R, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}
#### Lowest cases DNAm p-values
tab <- readr::read_csv("results/results_single_cpg_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(tab[order(tab$cases_pval_met.residual)[1:10],],
                    .margins = 1,
                    .fun = function(row){
                      plotTargetDNAm(row)
                    },.inform = TRUE
)
list
```



```{R, show = FALSE, fig.height = 8, include = FALSE, eval = FALSE}
#### Lowest control DNAm p-values
tab <- readr::read_csv("results/results_single_cpg_lm_250kb_window.csv", col_types = readr::cols())
list <- plyr::alply(tab[order(tab$control_pval_met.residual)[1:10],],
                    .margins = 1,
                    .fun = function(row){
                      plotTargetDNAm(row)
                    },.inform = TRUE
)
list
```


### Results

```{R}
tab.cpg <- readr::read_csv("results/results_single_cpg_lm_250kb_window.csv", col_types = readr::cols())
tab.cpg$fdr.controls <- p.adjust(tab.cpg$control_pval_met.residual,method = "fdr")
tab.cpg$fdr.cases <- p.adjust(tab.cpg$cases_pval_met.residual,method = "fdr")

output <- tab.cpg[,c("cpg","gene_external_gene_name",
                     "cases_estimate_met.residual","cases_pval_met.residual","fdr.cases",
                     "control_estimate_met.residual","control_pval_met.residual","fdr.controls")] 
colnames(output) <- c("cpg",
                      "geneSymbol",
                      "estimate.cases",
                      "pval.cases",
                      "estimate.controls",
                      "pval.controls"
)
```

```{R, eval = FALSE}
write.csv(output,file = "results/results_single_cpg_lm_250kb_window_renamed.csv")
```

```{R, eval = FALSE, include = FALSE}
output %>% dplyr::filter(output$fdr.cases < 0.01 | output$fdr.controls < 0.01) %>%
  DT::datatable(filter = 'top',
                style = "bootstrap",
                extensions = 'Buttons',
                options = list(scrollX = TRUE, 
                               dom = 'Bfrtip',
                               buttons = I('colvis'),
                               keys = TRUE, 
                               pageLength = 10), 
                rownames = FALSE,
                caption = "Liner model Target/DNAm results - single cpg")
```


# Splitting results by group 

## DMRs
```{R}
dmr <- read.csv(
  "results/results_regions_lm_250kb_window_renamed.csv"
)
pathDropbox <- file.path(dir("~", pattern = "Dropbox", full.names = TRUE))
dmr_meta <- read.csv(
  file.path(pathDropbox,
            "coMethDMR_metaAnalysis/",
            "code_validation/Meta_analysis_code/meta_analysis_region_results",
            "/step4_dmr_vs_cpgs/meta_analysis_sig_no_crossHyb_smoking_ov_comb_p_with_all.csv")
)[, c("ROSMAP_coMethRegion",
      "GREAT_annotation",
      "UCSC_RefGene_Group",
      "UCSC_RefGene_Accession",
      "UCSC_RefGene_Name",
      "state")
  ]

dmr.annot <- merge(
  dmr, dmr_meta,
  by.x = "coMethDMR",
  by.y = "ROSMAP_coMethRegion",
  sort = FALSE
)

dmr.annot <- dmr.annot[, c(1,3:9,21:24,10,25,11:18)]
```

```{R, eval = FALSE}
write.csv(
  dmr.annot,
  "results_regions_lm_250kb_window_renamed_with_annot.csv"
)
```

```{R}
dmr_case <- dmr.annot %>%
  group_by(coMethDMR) %>%
  filter(pval.cases == min(pval.cases)) %>%
  as.data.frame()

dmr_case$fdr.cases.adjusted <- p.adjust(
  dmr_case$pval.cases, method = "fdr"
)

dmr_case <- dmr_case[,c(1:4, 23,9:22)]
dmr_case
```

```{R, eval = FALSE}
write.csv(
  dmr_case,
  "results_regions_lm_250kb_window_renamed_mostSigCases.csv",
  row.names = FALSE
)
```

```{R}
dmr_control <- dmr.annot %>%
  group_by(coMethDMR) %>%
  filter(pval.controls == min(pval.controls)) %>%
  as.data.frame()
dmr_control$fdr.controls.adjusted <- p.adjust(
  dmr_control$pval.controls, method = "fdr"
)
dmr_control <- dmr_control[,c(1:2, 6:7, 23,9:22)]
dmr_control
```

```{R, eval = FALSE}
write.csv(
  dmr_control,
  "results_regions_lm_250kb_window_renamed_mostSigControls.csv",
  row.names = FALSE
)

```

## CpGs
```{R}
cpg <- read.csv(
  "results/results_single_cpg_lm_250kb_window_renamed.csv"
)
cpg_meta <- read.csv(
    file.path(pathDropbox,
            "coMethDMR_metaAnalysis/",
            "code_validation/Meta_analysis_code/meta_analysis_single_cpg_results/",
            "/meta_analysis_single_cpg_sig_no_crossHyb_smoking_with_state_greatAnnot_df.csv")
)[, c("cpg",
      "GREAT_annotation",
      "UCSC_RefGene_Group",
      "UCSC_RefGene_Accession",
      "UCSC_RefGene_Name",
      "Relation_to_Island",
      "state",
      "estimate", 
      "se", 
      "pVal.fixed", 
      "pVal.random",
      "pValQ", 
      "direction", 
      "pVal.final", 
      "fdr")
  ]

cpg.annot <- merge(
  cpg, cpg_meta,
  by = "cpg",
  sort = FALSE
) %>%
  select(-X)
cpg.annot
```

```{R, eval = FALSE}
write.csv(
  cpg.annot,
  "results_single_cpg_lm_250kb_window_renamed_with_annot.csv"
)
```

```{R}
cpg_case <- cpg.annot %>%
  group_by(cpg) %>%
  filter(pval.cases == min(pval.cases)) %>%
  as.data.frame()

cpg_case$fdr.cases.adjusted <- p.adjust(
  cpg_case$pval.cases, method = "fdr"
)
cpg_case <- cpg_case[, c(1:4, 25, 15,17:24)]
cpg_case
```

```{R, eval = FALSE}
write.csv(
  cpg_case,
  "results_single_cpg_lm_250kb_window_renamed_mostSigCases.csv",
  row.names = FALSE
)
```

```{R}
cpg_control <- cpg.annot %>%
  group_by(cpg) %>%
  filter(pval.controls == min(pval.controls)) %>%
  distinct(cpg, .keep_all = TRUE) %>%
  as.data.frame()

cpg_control$fdr.controls.adjusted <- p.adjust(
  cpg_control$pval.controls, method = "fdr"
)
cpg_control <- cpg_control[, c(1:2,6:7, 25, 15, 17:24)]
cpg_control
```

```{R, eval = FALSE}
write.csv(
  cpg_control,
  "results_single_cpg_lm_250kb_window_renamed_mostSigControls.csv",
  row.names = FALSE
)
```


# Session information
```{R}
devtools::session_info()
```
